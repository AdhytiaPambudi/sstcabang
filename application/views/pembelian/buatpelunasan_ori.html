{% extends "layout.html" %} {% block content %} {% include "navigation.html" %}
<style type="text/css">
    textarea {
       resize: none;
    }
    .modal .modal-body {
        overflow-y: auto;
        overflow-x: auto;
    }
</style>
<div id="progressGIF" style="position: fixed; top:0px; left:0px; bottom:0px; right:0px; background-color: rgba(0, 0, 0, 0.10); z-index: 1000; display: none;">
    <center>
    <img src="{{base_url}}assets/img/progress.gif" width="150px" style="padding-top: 15%; position: relative;">
    <p style="position: relative; font-size: 18px;">DATA SEDANG DI PROSES</p>
    </center>
</div>
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <!-- <h1 class="page-header">Terima Kiriman</h1> -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Pelunasan
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <form role="form" method="post" id="myForm">
                                <div class="form-group">
                                    <label class="control-label">No DIH</label>
                                    <select name="nodih" id="nodih" class="form-control" onchange="getDataDIH()">
                                        <option value="">-- Pilih No DIH --</option>
                                        {% for dih in dih %}
                                        <option value="{{dih.NoDIH}}">{{dih.NoDIH}}</option>
                                        {% endfor %}
                                    </select>
                                    <!-- <p class="help-block">notifikasi disini...</p> -->
                                </div>
                                <div class="form-group">
                                    <label class="control-label">Tanggal Pelunasan</label>
                                    <input class="form-control" name="tgl" id="tgl" value="{{tgl}}" readonly="" style="background-color: #eee">
                                    <!-- <p class="help-block">notifikasi disini...</p> -->
                                </div>
                                <div class="form-group">
                                    <!-- <label class="control-label">Total</label> -->
                                    <div class="table-responsive">
                                        <table class="table" id="total">
                                            <thead>
                                                <tr id = 'tr_header'>
                                                    <th>Total Faktur</th>
                                                    <th>Total Saldo Faktur</th>
                                                    <th>Total Pembulatan</th>
                                                    <th>Total Transfer</th>
                                                    <th>Total Materai</th>
                                                    <th>Total Pelunasan</th>
                                                    <th>Total Saldo Akhir</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr id = 'tr_detail'>
                                                    <td> 
                                                        <input type="text" name="total_faktur" id="total_faktur" class="form-control" readonly=""> 
                                                    </td>
                                                    <td> 
                                                        <input type="text" name="saldo_faktur" id="saldo_faktur" class="form-control" readonly=""> 
                                                    </td>
                                                    <td> 
                                                        <input type="text" name="total_pembulatan" id="total_pembulatan" class="form-control" readonly=""> 
                                                    </td>
                                                    <td> 
                                                        <input type="text" name="total_transfer" id="total_transfer" class="form-control" readonly=""> 
                                                    </td>
                                                    <td> 
                                                        <input type="text" name="total_materai" id="total_materai" class="form-control" readonly=""> 
                                                    </td>
                                                    <td> 
                                                        <input type="text" name="total_pelunasan" id="total_pelunasan" class="form-control" readonly=""> 
                                                    </td>
                                                    <td> 
                                                        <input type="text" name="total_saldo_akhir" id="total_saldo_akhir" class="form-control" readonly=""> 
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- /.table-responsive -->
                                </div>
                                <div class="form-group">
                                    <label class="control-label">Detail</label>
                                    <div class="table-responsive">
                                        <table class="table" id="dataDIH">
                                            <thead>
                                                <tr id = 'tr_header'>
                                                    <th>#</th>
                                                    <th>No Faktur</th>
                                                    <th>Dokumen</th>
                                                    <th>Pelanggan</th>
                                                    <th>Penagih</th>
                                                    <th>Salesman</th>
                                                    <th>Tanggal DIH</th>
                                                    <th>Tanggal Faktur</th>
                                                    <th>Total</th>
                                                    <th>Saldo</th>
                                                    <th>Tipe Pelunasan</th>
                                                    <th>Bank</th>
                                                    <th>Titipan</th>
                                                    <th>No Titipan</th>
                                                    <th id ='tambah'>Status Tambahan</th>
                                                    <th colspan="5" style="text-align:center">Value Tambahan</th>
                                                    <th>Value/Giro</th>
                                                    <th></th>
                                                    <th>Saldo Akhir</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                    <!-- /.table-responsive -->
                                </div>
                                <input type="hidden" name="bucket" id="bucket">
                                <button type="button" id="btnSave" onclick="saveData()" class="btn btn-primary">Save</button>
                                <button type="button" id="btnDot" class="btn btn-primary">Harap Tunggu, Sedang Proses Simpan Data.....</button>
                                <button type="button" class="btn btn-danger">Cancel</button>
                            </form>
                        </div>
                    </div>
                    <!-- /.row (nested) -->
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
</div>
<!-- /#page-wrapper -->

<!-- Bootstrap modal -->
<div class="modal fade" id="modal_form" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
        <form role="form" method="post" id="myForm2">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="modal-title">Form Add Giro</h3>
            </div>
            <div class="modal-body form">
                <div class="form-group-sm">
                    <div class="table-responsive">
                        <input type="hidden" name="row" id="row">
                        <table class="table" id="table-giro">
                            <thead>
                                <tr>
                                    <th>Bank</th>
                                    <th>Giro</th>
                                    <th>Tanggal JTO</th>
                                    <th>Value Giro</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="hidden" name="pelanggan" id="pelanggan" class="form-control"><input type="text" name="bank" id="bank" class="form-control"></td>
                                    <td><input type="text" name="giro" id="giro" class="form-control"></td>
                                    <td><input type="text" name="tgljto" id="tgljto" class="form-control"></td>
                                    <td><input type="text" name="valuegiro" id="valuegiro" class="form-control"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer form">
                <input type="hidden" name="bucket" id="bucket">
                <button type="button" id="btnSaveG" onclick="saveDataGiro()" class="btn btn-primary">Save</button>
            </div>
        </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!-- End Bootstrap modal -->

<!-- Bootstrap modal -->
<div class="modal fade" id="modal_form2" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
        <form role="form" method="post" id="myForm3">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="modal-title">List Faktur DIH</h3>
            </div>
            <div class="modal-body form">
                <div class="form-group-sm">
                    <div class="table-responsive">
                        <table width="100%" class="table table-striped table-bordered table-hover" " id="table-faktur-dih">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Aksi</th>
                                    <th>No DIH</th>
                                    <th>No Faktur</th>
                                    <th>Pelanggan</th>
                                    <th>Total</th>
                                    <th>Saldo</th>
                                    <th>Penagih</th>
                                    <th>Salesman</th>
                                    <th>Tanggal DIH</th>
                                    <th>Tanggal Faktur</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="modal_formssp" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
        <form role="form" method="post" id="form_ssp">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="modal-title">Form Add SSP</h3>
            </div>
            <div class="modal-body form">
                <div class="form-group-sm">
                    <div class="table-responsive">
                        <input type="hidden" name="row" id="row">
                        <table class="table" id="table-giro">
                            <thead>
                                <tr>
                                    <th>No DIH</th>
                                    <th>Tgl DIH</th>
                                    <th>No Faktur</th>
                                    <th>Tgl Faktur</th>
                                    <th>No NTPN</th>
                                    <th>NTB</th>
                                    <th>STAN</th>
                                    <th>Tgl Bayar</th>
                                    <th>Mata Anggaran</th>
                                    <th>Jenis Setoran</th>
                                    <th>Masa Pajak</th>
                                    <th>Jumlah Setoran</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" name="ssp_dih" id="ssp_dih" class="form-control" readonly=""></td>
                                    <td><input type="text" name="ssp_tgldih" id="ssp_tgldih" class="form-control" readonly=""></td>
                                    <td><input type="text" name="ssp_nofaktur" id="ssp_nofaktur" class="form-control" readonly=""></td>
                                    <td><input type="text" name="ssp_tglfaktur" id="ssp_tglfaktur" class="form-control" readonly=""></td>
                                    <td><input type="text" name="nontpn" id="nontpn" class="form-control" required></td>
                                    <td><input type="text" name="ntb" id="ntb" class="form-control" required></td>
                                    <td><input type="text" name="stan" id="stan" class="form-control" required></td>
                                    <td><input type="text" name="tglbayar" id="tglbayar" class="form-control" required></td>
                                    <td><input type="text" name="mata_anggaran" id="mata_anggaran" class="form-control" required></td>
                                    <td><input type="text" name="jenis_setoran" id="jenis_setoran" class="form-control" required></td>
                                    <td><input type="text" name="masa_pajak" id="masa_pajak" class="form-control" required></td>
                                    <td><input type="text" name="jumlah_setoran" id="jumlah_setoran" class="form-control" required></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer form">
                <input type="hidden" name="bucket" id="bucket">
                <button type="button" id="btnSaveG" onclick="saveDataSSP()" class="btn btn-primary">Save</button>
            </div>
        </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!-- End Bootstrap modal -->
{% endblock %}

{% block js %}
<script type="text/javascript">

$('#btnDot').hide();
$('#btnSave').show();

$(document).on('keydown', '.newRow', function(e) { 
  var aa;
  var keyCode = e.keyCode || e.which; 

  if (e.shiftKey == false && keyCode === 9) { 
    addRow();
    var b = document.getElementById('bucket').value;
    $('#nofaktur'+b).focus();
    // call custom function here
  } 
});

$(document).on('keydown', '.delRow', function(e) { 
  var keyCode = e.keyCode || e.which; 

  if (e.shiftKey && keyCode === 9) { 
    removeRow();
    // call custom function here
  } 
});

$( "#tglbayar").datepicker({
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true,
            format: 'yyyy-mm-dd',
            onClose: function(dateText, inst) { 
                $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
            }
        });

$("#tgljto").datepicker({
    changeMonth: true,
    changeYear: true,
    showButtonPanel: true,
    format: 'yyyy-mm-dd',
    onClose: function(dateText, inst) { 
        $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
    }
});

    var noFakturSource = [];
    function getDataDIH() {
        noFakturSource.length = 0;
        $('#progressGIF').show();
        $(".itemRow").remove();
        var nodih = document.getElementById('nodih').value;
        if ((nodih)){
            $.ajax({
                url : "{{ base_url }}getDataDIH/", //Controller => Pelunasan
                type: "POST",
                data:{nodih:nodih},
                dataType: "JSON",
                success: function(data)
                {
                    aa = data.length;
                    var x = 1;
                    var total_saldo = 0;
                    for ( i = 0; i <= data.length; i++) {
                        noFakturSource[i] = data[i].NoFaktur;
                        $('#dataDIH').append('<tr id="itemRow'+i+'" class="itemRow"><td>'+x+'</td><td><input type="text" name="nofaktur[]" id="nofaktur'+i+'" value="'+data[i].NoFaktur+'"  onkeyup="cariFaktur('+i+')" onchange="getFaktur('+i+')" readonly="" style="background-color: #eee;"></td><td><input type="text" name="dokumen[]" id="dokumen'+i+'" value="'+data[i].TipeDokumen+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="pelanggan[]" id="pelanggan'+i+'" value="'+data[i].Pelanggan+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="penagih[]" id="penagih'+i+'" value="'+data[i].Penagih+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="salesman[]" id="salesman'+i+'" value="'+data[i].Salesman+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="tgldih[]" id="tgldih'+i+'" value="'+data[i].TglDIH+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="tglfaktur[]" id="tglfaktur'+i+'" value="'+data[i].TglFaktur+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="total[]" id="total'+i+'" value="'+data[i].Total+'" readonly="" style="background-color: #eee;" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="saldo[]" id="saldo'+i+'" value="'+data[i].Saldo+'" readonly="" style="background-color: #eee;" onkeyup="hitung()" onchange="hitung()"></td><td><select name="tipe[]" id="tipe'+i+'" onchange="pilih_bank(this)"><option value="Cash">Cash</option><option value="Giro">Giro</option><option value="Transfer">Transfer</option></select></td><td><select name="bank_transfer[]" id="bank_transfer'+i+'" onchange="pilih_titipan(this)"><option value="">-- select one -- </option></select></td><td><select name="titipan[]" id="titipan'+i+'" ><option value="">-- select one -- </option></select></td><td><input type="text" name="notitipan[]" id="notitipan'+i+'" class="newRow"></td><td><select name="status_tambahan[]" id="status_tambahan'+i+'" onchange="pilih_tambahan(this)"><option value="">-- select one -- </option><option value="kelebihan">Kelebihan </option><option value="potongan">Potongan </option><option value="ssp">SSP </option></select></td><td><button type="button" id="btnAddssp'+i+'" onclick="addSsp('+"'"+nodih+"','"+data[i].NoFaktur+"','"+data[i].TglDIH+"','"+data[i].TglFaktur+"', '"+i+"'"+')" class="btn btn-primary" style="display:none">Add SSP</button></td><td><input type="text" name="ssp[]" id="ssp'+i+'" class="newRow" style="display:none" placeholder="ssp" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="pembulatan[]" id="pembulatan'+i+'" class="newRow" style="display:none" placeholder="pembulatan" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="biaya_transfer[]" id="biaya_transfer'+i+'" class="newRow" style="display:none" placeholder="biaya_transfer" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="materai[]" id="materai'+i+'" class="newRow" style="display:none" placeholder="materai" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="value[]" id="value'+i+'" class="newRow" onkeyup="hitung()" onchange="hitung()" onkeypress="return isNumberKey(event)"><input type="text" onkeyup="getval('+i+')" onchange="getval('+i+')" name="giro[]" id="giro'+i+'" class="newRow" style="display:none"></td><td><input type="text" name="val_giro[]" id="val_giro'+i+'" class="newRow" placeholder=0 readonly="" style="display:none;background-color: #eee;"></td><td><button type="button" id="btnAdd" onclick="addGiro('+"'"+data[i].Pelanggan+"', '"+i+"'"+')" class="btn btn-primary">Add Giro</button></td><td><input type="text" name="saldo_akhir[]" id="saldo_akhir'+i+'" class="newRow" placeholder=0 readonly="" style="background-color: #eee;" autocomplete="off"></td></tr>');
                        x++;
                        getGiro(data[i].Pelanggan,i);
                        getSSP(nodih,data[i].NoFaktur,i);
                        $("#bucket").val(i);
                    }
                    
                    // console.log(data.length);
                    
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    $("#notif").empty();
                    notif('danger','Error get list Produk from ajax');
                }
            });
        }
        $('#progressGIF').hide();
    }

    function pilih_bank(x){
        var baris = x.parentNode.parentNode.rowIndex-1;
        var gl_bank = []; 
         $.ajax({
            url : "{{ base_url }}get_gl_bank",
            type: "POST",
            // dataType: "JSON",
            success: function(data)
            {
                switch(x.value){
                    case "Transfer":
                        var response = JSON.parse(data);
                        $.each(response,function(key, value){
                            $("#bank_transfer"+baris).append('<option value="'+ value.perkiraan +'">' + value.perkiraan + '</option>');
                        });
                        $("#giro"+baris).hide();
                        $("#giro"+baris).val('');
                        $("#val_giro"+baris).hide();
                        $("#val_giro"+baris).val(0);
                        $("#value"+baris).val('');
                        $("#value"+baris).show(); 
                        hitung();
                        break;
                    case "Giro" :
                        $("#giro"+baris).show();
                        $("#value"+baris).val('');
                        $("#value"+baris).hide();
                        $("#val_giro"+baris).hide();
                        // $("#val_giro"+baris).val(0);
                        $("#bank_transfer"+baris).html("<option value =''>--------</option>");
                        // hitung();
                        break;
                    case "Cash" :
                        $("#giro"+baris).hide();
                        $("#giro"+baris).val('');
                        $("#val_giro"+baris).hide();
                        $("#val_giro"+baris).val(0);
                        $("#value"+baris).show();
                        $("#value"+baris).val(''); 
                        $("#bank_transfer"+baris).html("<option value =''>--------</option>");
                        hitung();
                        break;
                    // default:
                    //     $("#giro"+baris).hide();
                    //     $("#giro"+baris).val('');
                    //     $("#value"+baris).show(); 
                    //     $("#bank_transfer"+baris).html("<option value =''>--------</option>")
                    //     break;
                }
            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                notif('warning', 'PERHATIAN! Gagal ');
            }
        });   
    }

    function pilih_titipan(x){
        var baris = x.parentNode.parentNode.rowIndex-1;
        if(x.value == ''){
            $("#titipan"+baris).html("<option value=''>--------</option>");
        }else{
            $("#titipan"+baris).html("<option value='titipan'>Titipan</option><option value='bukan'>Bukan</option>");
        }   
    }

    function pilih_tambahan(x){
        var baris = x.parentNode.parentNode.rowIndex-1;
        var tr_head = document.getElementById("tr_header");
        var row = document.getElementById("itemRow"+baris);
        // var c = CountRows(baris);
        if(x.value == 'kelebihan'){
            document.getElementById('pembulatan'+baris).value = 0;
            document.getElementById('biaya_transfer'+baris).value = 0;
            document.getElementById('materai'+baris).value = 0;
            document.getElementById('pembulatan'+baris).style.display = 'block';
            document.getElementById('biaya_transfer'+baris).style.display = 'none';
            document.getElementById('materai'+baris).style.display = 'none';
            document.getElementById('btnAddssp'+baris).style.display = 'none';
            document.getElementById('ssp'+baris).style.display = 'none';
            hitung();
        }else if(x.value == 'potongan'){
            document.getElementById('pembulatan'+baris).value = 0;
            document.getElementById('biaya_transfer'+baris).value = 0;
            document.getElementById('materai'+baris).value = 0;
            document.getElementById('pembulatan'+baris).style.display = 'block';
            document.getElementById('biaya_transfer'+baris).style.display = 'block';
            document.getElementById('materai'+baris).style.display = 'block';
            document.getElementById('btnAddssp'+baris).style.display = 'none';
            document.getElementById('ssp'+baris).style.display = 'none';
            hitung();
        }else if(x.value == 'ssp'){
            document.getElementById('pembulatan'+baris).value = 0;
            document.getElementById('biaya_transfer'+baris).value = 0;
            document.getElementById('materai'+baris).value = 0;
            document.getElementById('biaya_transfer'+baris).style.display = 'block';
            document.getElementById('materai'+baris).style.display = 'block';
            document.getElementById('btnAddssp'+baris).style.display = 'block';
            document.getElementById('ssp'+baris).style.display = 'block';
            document.getElementById('pembulatan'+baris).style.display = 'block';
            hitung();
        }else{
            document.getElementById('pembulatan'+baris).value = 0;
            document.getElementById('biaya_transfer'+baris).value = 0;
            document.getElementById('materai'+baris).value = 0;
            document.getElementById('pembulatan'+baris).style.display = 'none';
            document.getElementById('biaya_transfer'+baris).style.display = 'none';
            document.getElementById('materai'+baris).style.display = 'none';
            document.getElementById('btnAddssp'+baris).style.display = 'none';
            document.getElementById('ssp'+baris).style.display = 'none';
            hitung();
        } 
    }

    // function CountRows(baris) {
    //     var totalRowCount = 0;
    //     var rowCount = 0;
    //     var table = document.getElementById("dataDIH");
    //     var rows = table.getElementsByTagName("tr")
    //     for (var i = 0; i < rows.length; i++) {
    //         if((rowCount+i) == (baris+1)){
    //             var td_row = rows[i].getElementsByTagName("td").length;
    //         }
    //     }
    //     return td_row;
    // }

    function saveData()
    {
        // var bucket = document.getElementById('bucket').value;
        var status = true;
        var data_form = [];
        for (var i = 0; i < aa; i++) { 
            var data ={};    
            var nodih   = document.getElementById('nodih').value;    
            var tipe    = document.getElementById('tipe'+i).value;
            var value   = document.getElementById('value'+i).value;
            var giro    = document.getElementById('giro'+i).value;
            var saldo   = document.getElementById('saldo'+i).value;
            var status_tambahan = document.getElementById('status_tambahan'+i).value;
            var tglfaktur    = document.getElementById('tglfaktur'+i).value;
            var nofaktur = document.getElementById('nofaktur'+i).value;
            var dokumen  = document.getElementById('dokumen'+i).value;
            var pelanggan = document.getElementById('pelanggan'+i).value;
            var penagih   = document.getElementById('penagih'+i).value;
            var salesman  = document.getElementById('salesman'+i).value;
            var tgldih    = document.getElementById('tgldih'+i).value;
            var total     = document.getElementById('total'+i).value;
            var titipan   = document.getElementById('titipan'+i).value;
            var notitipan = document.getElementById('notitipan'+i).value;
            var bank_transfer = document.getElementById('bank_transfer'+i).value;
            var ssp = document.getElementById('ssp'+i).value;
            if (tipe == 'Giro') {
                if (giro == "") {
                    notif('warning', 'PERHATIAN! Kolom Value/Giro Tidak boleh kosong ke : '+i);
                    status = false;
                }
            }
            else{
                if (value == "") {
                    notif('warning', 'PERHATIAN! Kolom Value/Giro Tidak boleh kosong ke :' + i);
                    status = false;
                }
                else if (parseInt(value) > Math.abs(parseInt(saldo))) {
                    notif('warning', 'PERHATIAN! Jumlah pembayaran('+value+') tidak boleh lebih besar dari saldo sisa faktur('+saldo+').');
                    status = false;
                }
            }
            if(tipe == 'Transfer'){
                if(bank_transfer == ""){
                    notif('warning', 'PERHATIAN! Kolom Bank wajib di isi');
                    status = false;
                }
            }else{
                    bank_transfer    = "";
                    titipan = "";
            }                        
            if(status_tambahan == "" ){
                var pembulatan = 0;
                var biaya_transfer = 0;
                var materai = 0;
            }else if(status_tambahan == 'kelebihan'){
                var pembulatan = document.getElementById('pembulatan'+i).value;
                var biaya_transfer = 0;
                var materai = 0;
                if(pembulatan == ""){
                    pembulatan = 0;
                }

            }else if(status_tambahan == 'potongan'){
                var pembulatan = document.getElementById('pembulatan'+i).value;
                var biaya_transfer = document.getElementById('biaya_transfer'+i).value;
                var materai = document.getElementById('materai'+i).value;
                if(pembulatan == ""){
                    pembulatan = 0;
                }
                if(biaya_transfer == ""){
                    biaya_transfer = 0;
                }
                if(materai == ""){
                    materai = 0;
                }
            }else if(status_tambahan == 'ssp'){
                var pembulatan = document.getElementById('pembulatan'+i).value;
                var biaya_transfer = document.getElementById('biaya_transfer'+i).value;
                var materai = document.getElementById('materai'+i).value;
                if(pembulatan == ""){
                    pembulatan = 0;
                }
                if(biaya_transfer == ""){
                    biaya_transfer = 0;
                }
                if(materai == ""){
                    materai = 0;
                }
            }
            $('#btnDot').show();
            $('#btnSave').hide();
            $('#progressGIF').show();
            document.getElementById('btnSave').disabled = true;
            data.tipe               =tipe;
            data.value              =value;
            data.giro               =giro;
            data.saldo              =saldo;
            data.status_tambahan    =status_tambahan;
            data.nodih              =nodih;
            data.nofaktur           =nofaktur;
            data.dokumen            =dokumen;
            data.pelanggan          =pelanggan;
            data.penagih            =penagih;
            data.salesman           =salesman;
            data.tglfaktur          =tglfaktur;
            data.tgldih             =tgldih;
            data.total              =total;
            data.titipan            =titipan;
            data.notitipan          =notitipan;
            data.pembulatan         =pembulatan;
            data.biaya_transfer     =biaya_transfer;
            data.materai            =materai;
            data.bank_transfer      =bank_transfer;
            data.ssp                =ssp;
            data_form.push(data);
        }
        if (status == true) {
            $('#progressGIF').show();
            $.ajax({
                url : "{{ base_url }}saveDataPelunasan",
                type: "POST",
                data: {data_form},
                dataType: "JSON",
                success: function(data)
                {                
                    $('#progressGIF').hide();
                    if (data.status == false) {
                        notif('warning', 'PERHATIAN! Tidak dapat terhubung dengan server pusat');
                    }
                    else{
                        notif('success', 'SUKSES! Data berhasil disimpan ke server pusat');
                    }
                    location.reload();
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                   notif('warning', 'PERHATIAN! Tidak dapat terhubung dengan server pusat');
                   location.reload();
                   $('#progressGIF').hide();
                }
            });
            $('#progressGIF').hide();
        }
        else{
            $('#progressGIF').hide();
        }
        $('#progressGIF').hide();
        document.getElementById("btnSave").disabled = false;
    }

    function getGiro(pelanggan,e,saldo) {
                    // console.log(pelanggan);
        var giroSource = [];
        $.ajax({
            url : "{{ base_url }}listGiro/"+pelanggan,
            type: "GET",
            dataType: "JSON",

            success: function(data)
            {
                for (var i in data) {
                    giroSource[i] = data[i].NoGiro+' | '+data[i].SisaGiro;
                }

            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                notif('warning', 'PERHATIAN! Gagal tarik data giro');
            }
        }); 
        // var bucket = document.getElementById('bucket').value; 
        // for (var i = 0; i <= bucket; i++) {
        //     var p = document.getElementById('pelanggan'+i).value;
        //     if (pelanggan == p) {
                $('#giro'+e).typeahead('destroy');
                $('#giro'+e).typeahead({
                    source: giroSource,
                });
            // }
        // }        
    }

    function getSSP(ssp_dih,ssp_nofaktur,e) {
                    // console.log(pelanggan);
        var sspSource = [];
        $.ajax({
            url : "{{ base_url }}listSSP/",
            type: "POST",
            data:{dih:ssp_dih,nofaktur:ssp_nofaktur},
            dataType: "JSON",
            success: function(data)
            {
                for (var i in data) {
                    sspSource[i] = data[i].NoNTPN+' | '+data[i].JumlahSetoran;
                }

            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                notif('warning', 'PERHATIAN! Gagal tarik data giro');
            }
        }); 
        // var bucket = document.getElementById('bucket').value; 
        // for (var i = 0; i <= bucket; i++) {
        //     var p = document.getElementById('pelanggan'+i).value;
        //     if (pelanggan == p) {
                $('#ssp'+e).typeahead('destroy');
                $('#ssp'+e).typeahead({
                    source: sspSource,
                });
            // }
        // }        
    }

    function addGiro(pelanggan, i) {
        $('#modal_form').modal('show');
        $('#pelanggan').val(pelanggan);
        $('#row').val(i);
    }

    function addSsp(nodih,NoFaktur,TglDIH,TglFaktur,i) {
        $('#modal_formssp').modal('show');
        $('#ssp_dih').val(nodih);
        $('#ssp_tgldih').val(TglDIH);
        $('#ssp_nofaktur').val(NoFaktur);
        $('#ssp_tglfaktur').val(TglFaktur);
        $('#row').val(i);
    }

    function saveDataGiro()
    {
        var row = document.getElementById('row').value;
        var pelanggan = document.getElementById('pelanggan').value;
        $('#progressGIF').show();
            $.ajax({
                url : "{{ base_url }}saveDataGiro",
                type: "POST",
                data: $('#myForm2').serialize(),
                dataType: "JSON",
                success: function(data)
                {        
                    notif('success', 'SUKSES! Data berhasil disimpan');
                    $('#progressGIF').hide();
                    getGiro(pelanggan);
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                   notif('warning', 'PERHATIAN! Data gagal disimpan');
                   $('#progressGIF').hide();
                }
            });
        $('#modal_form').modal('hide');
        $('#myForm2')[0].reset();
    }

    function saveDataSSP()
    {
        var row             = document.getElementById('row').value;
        var ssp_dih         = document.getElementById('ssp_dih').value;
        var ssp_tgldih      = document.getElementById('ssp_tgldih').value;
        var ssp_nofaktur    = document.getElementById('ssp_nofaktur').value;
        var ssp_tglfaktur   = document.getElementById('ssp_tglfaktur').value;
        var nontpn          = document.getElementById('nontpn').value;
        var ntb             = document.getElementById('ntb').value;
        var stan            = document.getElementById('stan').value;
        var tglbayar        = document.getElementById('tglbayar').value;
        var mata_anggaran   = document.getElementById('mata_anggaran').value;
        var jenis_setoran   = document.getElementById('jenis_setoran').value;
        var masa_pajak      = document.getElementById('masa_pajak').value;
        var bayar           = $('#jumlah_setoran').val();

        if(ssp_dih == '' || ssp_tgldih == '' || ssp_nofaktur == '' || ssp_tglfaktur == '' || ntb == '' || stan == '' || tglbayar == '' || mata_anggaran == '' || jenis_setoran == '' || masa_pajak == '' || bayar == '' || bayar == 0){
            notif('warning', 'PERHATIAN! Terdapat Data Inputa yg masih Kosong atau Jumlah Setoran masih 0');
            return;
        }
        $('#progressGIF').show();
            $.ajax({
                url : "{{ base_url }}saveDataSSP",
                type: "POST",
                data: $('#form_ssp').serialize(),
                dataType: "JSON",
                success: function(data)
                {        
                    notif('success', 'SUKSES! Data berhasil disimpan');
                    document.getElementById('ssp'+row).value = nontpn +' | '+ bayar;
                    document.getElementById('pembulatan'+row).value = bayar;
                    $('#progressGIF').hide();
                    getSSP(ssp_dih,ssp_nofaktur);
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                   notif('warning', 'PERHATIAN! Data gagal disimpan');
                   $('#progressGIF').hide();
                }
            });
        $('#modal_formssp').modal('hide');
        $('#form_ssp')[0].reset();
    }

    // function tipe(e) {
    //     var tipe = document.getElementById('tipe'+e).value;
    //     var dokumen = document.getElementById('dokumen'+e).value;
    //     var pelanggan = document.getElementById('pelanggan'+e).value;
    //     if(dokumen == "Faktur"){
    //         if (tipe == 'Giro') {
    //             getGiro(pelanggan);
    //             $("#giro"+e).show();
    //             $("#value"+e).hide();
    //         }else{
    //             $("#giro"+e).hide();
    //             $("#value"+e).show();   
    //         }
    //     }
    //     else{
    //         if (tipe == 'Giro') {
    //             $("#tipe"+e).val('Cash');
    //             notif("warning", "PERHATIAN! Pelunasan retur tidak bisa menggunakan giro");
    //         }
    //     }
    // }

    function addRow() {
        var bucket = document.getElementById('bucket').value;
        var i = parseInt(bucket) + 1;
        var x = parseInt(bucket) + 2;
        $('#dataDIH').append('<tr id="itemRow'+i+'" class="itemRow"><td>'+x+'</td><td><input type="text" name="nofaktur[]" id="nofaktur'+i+'" onkeyup="cariFaktur('+i+')" onchange="getFaktur('+i+')" class="delRow"></td><td><input type="text" name="dokumen[]" id="dokumen'+i+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="pelanggan[]" id="pelanggan'+i+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="penagih[]" id="penagih'+i+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="salesman[]" id="salesman'+i+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="tgldih[]" id="tgldih'+i+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="tglfaktur[]" id="tglfaktur'+i+'" readonly="" style="background-color: #eee;"></td><td><input type="text" name="total[]" id="total'+i+'" readonly="" style="background-color: #eee;" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="saldo[]" id="saldo'+i+'" readonly="" style="background-color: #eee;" onkeyup="hitung()" onchange="hitung()"></td><td><select name="tipe[]" id="tipe'+i+'" onchange="pilih_bank(this)"><option value="Cash">Cash</option><option value="Giro">Giro</option><option value="Transfer">Transfer</option></select></td><td><select name="bank_transfer[]" id="bank_transfer'+i+'" onchange="pilih_titipan(this)"><option value="">-- select one -- </option></select></td><td><select name="titipan[]" id="titipan'+i+'" ><option value="">-- select one -- </option></select></td><td><input type="text" name="notitipan[]" id="notitipan'+i+'" class="newRow"></td><td><select name="status_tambahan[]" id="status_tambahan'+i+'" onchange="pilih_tambahan(this)"><option value="">-- select one -- </option><option value="kelebihan">Kelebihan </option><option value="potongan">Potongan </option></select></td><td><input type="text" name="pembulatan[]" id="pembulatan'+i+'" class="newRow" style="display:none" placeholder="pembulatan" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="biaya_transfer[]" id="biaya_transfer'+i+'" class="newRow" style="display:none" placeholder="biaya_transfer" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="materai[]" id="materai'+i+'" class="newRow" style="display:none" placeholder="materai" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="value[]" id="value'+i+'" class="newRow" onkeyup="hitung()" onchange="hitung()" onkeypress="return isNumberKey(event)"><input type="text" style="display:none" name="giro[]" id="giro'+i+'" class="newRow" onkeyup="getval()" onchange="getval()" style="display:none"></td><td><button type="button" id="btnAdd" onclick="addGiro('+"'"+data[i].Pelanggan+"', '"+i+"'"+')" class="btn btn-primary">Add Giro</button></td><td><input type="text" name="val_giro[]" id="val_giro'+i+'" class="newRow" placeholder=0 readonly="" style="background-color: #eee;" style="display:none"></td><td><input type="text" name="saldo_akhir[]" id="saldo_akhir'+i+'" class="newRow" placeholder=0 readonly="" style="background-color: #eee;" autocomplete="off"></td></tr>');
        $("#bucket").val(i);
    }

    function removeRow() 
    {
        var bucket = document.getElementById('bucket').value;
            $('#itemRow'+bucket).remove();
            bucket--;
        $('#bucket').val(bucket);
    }

    function cariFaktur(e){  
        $('#nofaktur'+e).typeahead({
                source: noFakturSource
            });
    }

    function getFaktur(e){
        var bucket =document.getElementById('bucket').value; 
        var nofaktur = document.getElementById('nofaktur'+e).value;
        var nodih = document.getElementById('nodih').value;
        $.ajax({
            url : "{{ base_url }}getFakturDIH/",
            type: "POST",
            data:{nodih:nodih, nofaktur:nofaktur},
            dataType: "JSON",
            success: function(data)
            {   
                if (data)
                {
                    $('#pelanggan'+e).val(data.Pelanggan);
                    $('#dokumen'+e).val(data.TipeDokumen);
                    $('#penagih'+e).val(data.Penagih);
                    $('#salesman'+e).val(data.Salesman);
                    $('#tgldih'+e).val(data.TglDIH);
                    $('#tglfaktur'+e).val(data.TglFaktur);
                    $('#total'+e).val(data.Total);
                    $('#saldo'+e).val(data.Saldo);
                    getGiro(data.Pelanggan);
                }
            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                
            }
        });
    }

    function showModal() {
        $('#modal_form2').modal('show');
        tabel.ajax.reload();
    }
     function hitung() {
        var value = 0;
        var saldo_akhir =0;
        var total_all = 0;  
        var total_saldo = 0;
        var total_pembulatan = 0;
        var total_transfer =  0;
        var total_materai  = 0;
        var total_value = 0;
        var total_saldo_akhir=0;
        var valid = true;

        var bucket = ((document.getElementById('bucket').value) ? document.getElementById('bucket').value : 0);
        for (var e = 0; e <= bucket; e++) {
            var dokumen = ((document.getElementById('dokumen'+e).value) ? document.getElementById('dokumen'+e).value : "");
            var pelanggan = ((document.getElementById('pelanggan'+e).value) ? document.getElementById('pelanggan'+e).value : "");
            var tipe = ((document.getElementById('tipe'+e).value) ? document.getElementById('tipe'+e).value : "");
            var total = parseInt((document.getElementById('total'+e).value) ? document.getElementById('total'+e).value : 0);
            var saldo = parseInt((document.getElementById('saldo'+e).value) ? document.getElementById('saldo'+e).value : 0);
            var pembulatan = parseInt((document.getElementById('pembulatan'+e).value) ? document.getElementById('pembulatan'+e).value : 0);

            var transfer = ((document.getElementById('biaya_transfer'+e).value) ? document.getElementById('biaya_transfer'+e).value : 0);
            var materai = ((document.getElementById('materai'+e).value) ? document.getElementById('materai'+e).value : 0);
            var value = ((document.getElementById('value'+e).value) ? document.getElementById('value'+e).value : 0);
            var giro = ((document.getElementById('giro'+e).value) ? document.getElementById('giro'+e).value : "");
            var ssp = ((document.getElementById('ssp'+e).value) ? document.getElementById('ssp'+e).value : "");
            var expld = ssp.split(" | ");
            var data_ssp = expld[0];
            var val_ssp = expld[1];
            if(ssp != ''){
                $('#pembulatan'+e).val(val_ssp);
            }

            if( (parseFloat(pembulatan) + parseFloat(transfer) + parseFloat(materai) + parseFloat(value)) > Math.abs(parseFloat(saldo)) )
            {
                notif('warning', 'PERHATIAN! value pelunasan tidak boleh melebihi saldo faktur '); 
                valid = false;
            }
            if(tipe != 'Giro'){
                val_pelunasan = parseInt(pembulatan) + parseInt(transfer) + parseInt(materai) + parseInt(value);
                if(dokumen == 'Faktur' || dokumen =='DN'){
                    var saldo_faktur = saldo - val_pelunasan;
                }else{
                    var saldo_faktur = saldo + val_pelunasan;
                }
                $('#saldo_akhir'+e).val(numberWithCommas(saldo_faktur));
            }
            total_all        = total_all + parseInt(total);  
            total_saldo      = total_saldo + parseInt(saldo);
            total_pembulatan = total_pembulatan + parseInt(pembulatan);
            total_transfer   = total_transfer + parseInt(transfer);
            total_materai    = total_materai + parseInt(materai);
            total_value      = total_value + parseInt(value);
            total_saldo_akhir = total_saldo_akhir + parseInt(saldo_faktur);
        }
        $('#total_faktur').val(numberWithCommas(total_all));
        $('#saldo_faktur').val(numberWithCommas(total_saldo));
        $('#total_pembulatan').val(numberWithCommas(total_pembulatan));
        $('#total_transfer').val(numberWithCommas(total_transfer));
        $('#total_materai').val(numberWithCommas(total_materai));
        $('#total_pelunasan').val(numberWithCommas(total_value));
        $('#total_saldo_akhir').val(numberWithCommas(total_saldo_akhir));
    }

    function getval(x){
        var total_all = 0;  
        var total_saldo = 0;
        var total_pembulatan = 0;
        var total_transfer =  0;
        var total_materai  = 0;
        var total_value = 0;
        var total_saldo_akhir=0;
        var bucket = ((document.getElementById('bucket').value) ? document.getElementById('bucket').value : 0);
        var girox = document.getElementById('giro'+x).value;
        var pembulatan = parseInt((document.getElementById('pembulatan'+x).value) ? document.getElementById('pembulatan'+x).value : 0);
        var transfer = ((document.getElementById('biaya_transfer'+x).value) ? document.getElementById('biaya_transfer'+x).value : 0);
        var materai = ((document.getElementById('materai'+x).value) ? document.getElementById('materai'+x).value : 0);
        var value = 0;
        var saldo = parseInt((document.getElementById('saldo'+x).value) ? document.getElementById('saldo'+x).value : 0);
        var dokumen = ((document.getElementById('dokumen'+x).value) ? document.getElementById('dokumen'+x).value : "");
        var xpl = girox.split(" | ");
        var dgiro = xpl[0];
        var vgiro = xpl[1];
        var saldo_akhir = 0;
        var saldo_faktur = 0;
        var j=0;
        for (var e = 0; e <= bucket; e++) {
            var tipe = document.getElementById('tipe'+e).value;
            var total = document.getElementById('total'+e).value;
            var saldofaktur = document.getElementById('saldo'+e).value;
            var bulat = parseInt((document.getElementById('pembulatan'+e).value) ? document.getElementById('pembulatan'+e).value : 0);
            var tf = ((document.getElementById('biaya_transfer'+e).value) ? document.getElementById('biaya_transfer'+e).value : 0);
            var mater = ((document.getElementById('materai'+e).value) ? document.getElementById('materai'+e).value : 0);
            var giro = document.getElementById('giro'+e).value;
            if(tipe == "Giro"){
                if(giro != ""){
                    $('#val_giro'+e).show();
                    var xpld = giro.split(" | ");
                    var dtgiro = xpld[0];
                    var nilai = xpld[1];
                    if(dtgiro == dgiro){
                        j=j+1;
                        if(saldo_akhir == 0 && j == 1){
                            if(parseInt(saldofaktur) > parseInt(nilai)){
                                value = parseInt(nilai);
                                saldo_akhir = parseInt(saldo_akhir) + parseInt(nilai);
                                console.log("1"); 
                            }else{
                                value = parseInt(saldofaktur);
                                saldo_akhir = parseInt(saldo_akhir) + parseInt(nilai) - parseInt(saldofaktur); 
                                console.log("2");
                            }  
                        }else{
                            if(parseInt(saldofaktur) > parseInt(saldo_akhir)){
                                value = parseInt(saldo_akhir);
                                saldo_akhir = 0;   
                                console.log("3"); 
                            }else{
                                value = parseInt(saldofaktur);
                                saldo_akhir = parseInt(saldo_akhir) - parseInt(saldofaktur);
                                console.log("4");
                            }  
                        }
                    document.getElementById('val_giro'+e).value = saldo_akhir; 
                    }
                    
                      
                }else{
                    document.getElementById('val_giro'+e).value = 0; 
                    // document.getElementById('saldo_akhir'+x).value = saldofaktur;
                    $('#val_giro'+e).hide();
                    // hitung();
                }
            }
            else{
                console.log("bukan giro");
                document.getElementById('val_giro'+e).value = 0; 
                $('#val_giro'+e).hide();
                // document.getElementById('saldo_akhir'+e).value = saldofaktur;
            }
            console.log(value);
            total_all        = total_all + parseInt(total); 
            total_saldo      = total_saldo + parseInt(saldofaktur);
            total_pembulatan = total_pembulatan + parseInt(bulat);
            total_transfer   = total_transfer + parseInt(tf);
            total_materai    = total_materai + parseInt(mater);
            total_value      = total_value + parseInt(value);
        }

        val_pelunasan = parseInt(pembulatan) + parseInt(transfer) + parseInt(materai) + parseInt(value);
        if(dokumen == 'Faktur' || dokumen =='DN'){
            var saldo_faktur = parseInt(saldo) - val_pelunasan;
        }else{
            var saldo_faktur = parseInt(saldo) + val_pelunasan;
        }
        $('#saldo_akhir'+x).val(numberWithCommas(saldo_faktur));
        $('#total_faktur').val(numberWithCommas(total_all));
        $('#saldo_faktur').val(numberWithCommas(total_saldo));
        $('#total_pembulatan').val(numberWithCommas(total_pembulatan));
        $('#total_transfer').val(numberWithCommas(total_transfer));
        $('#total_materai').val(numberWithCommas(total_materai));
        $('#total_pelunasan').val(numberWithCommas(total_value));
    }
</script>
{% endblock %}