{% extends "layout.html" %} {% block content %} {% include "navigation.html" %}
<style type="text/css">
    .modal .modal-body {
    overflow-y: auto;
    overflow-x: auto;
}
</style>
<div id="progressGIF" style="position: fixed; top:0px; left:0px; bottom:0px; right:0px; background-color: rgba(0, 0, 0, 0.10); z-index: 1000; display: none;">
    <center>
    <img src="{{base_url}}assets/img/progress.gif" width="150px" style="padding-top: 15%; position: relative;">
    <p style="position: relative; font-size: 18px;">DATA SEDANG DI PROSES</p>
    </center>
</div>                       
<form role="form" id="myForm" enctype="multipart/form-data">
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <!-- <h1 class="page-header">Data Order</h1> -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->    
    <div class="row">
        <div class="col-lg-12">
            <!-- /.panel -->
            <span>Ket: F1(Tambah Baris), F2(Save Data), F4(Hapus Baris)</span>
            <div class="panel panel-default" id="divOrder">
                <div class="panel-heading" style="min-height: 35px">
                    <div style="width:50%;float:left;">
                        <b>Mutasi Batch</b>
                    </div>
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body"> 
                    <div class="col-lg-1" style="padding-right: 0px; padding-left: 10px">
                        <div class="form-group-sm">
                            <label class="control-label">Cabang</label>
                            <input class="form-control" type="text" name="cabang" id="cabang" value="{{logs.cabang}}" readonly="">
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </div>
                    </div>
                    <div class="col-lg-1" style="padding-right: 0px; padding-left: 10px">
                        <div class="form-group-sm">
                            <label class="control-label">Tanggal</label>
                            <input class="form-control" type="text" name="tgl" id="tgl" value="{{tgl}}" readonly="">
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </div>
                    </div>

                    <div class="col-lg-2" style="padding-right: 0px; padding-left: 10px"> 
                        <div class="form-group-sm">
                            <label class="control-label">No Mutasi</label>
                            <input class="form-control" type="text" name="no" id="no" value="{{no}}" readonly="">
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </div>
                    </div>
                    <div class="col-lg-2" style="padding-right: 0px; padding-left: 10px">
                        <div class="form-group-sm">
                            <label class="control-label">Gudang</label>
                            <select name="gudang" id="gudang" onchange="setBatch(0)" class="form-control">
                                <option>Pilih</option>
                                <option>Baik</option>
                                <option>Git</option>
                                <option>Pusat</option>
                                <option>Relokasi</option>
                            </select>
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </div>
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <div></div>
    <div class="row">
        <div class="col-lg-12">
            <!-- /.panel -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <b>Produk</b>
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">  
                    <div class="form-group-sm">
                        <div class="table-responsive">
                            <table class="table" id="table-produk">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Produk</th>
                                        <th>Pilih Batch</th>
                                        <th>Batch No</th>
                                        <th>stok</th>
                                        <th>Exp Date</th>
                                        <th>Doc Stok Awal</th>
                                        <th>Jumlah</th>
                                        <th>Pilih New Batch</th>
                                        <th>New Batch</th>
                                        <th>New Exp Date</th>
                                        <th>Doc Stok Akhir</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="itemRow0">
                                        <td>1</td>
                                        <td>
                                            <input type="text" name="produk[0]" id="produk0" class="delRow"  onkeyup="cariKode(0)" onchange="getProduk(0)" autocomplete="off">
                                        </td>
                                        <td>
                                            <select name="batchdetail[0]" id="batchdetail0" onchange="setBatch(0)" style="width: 200px">
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" name="batch[0]" id="batch0" style="background-color:#ccc;" readonly="">
                                        </td>
                                        <td>
                                            <input type="text" name="stok[0]" id="stok0" style="background-color:#ccc;" readonly="">
                                        </td>
                                        <td>
                                            <input type="text" name="expdate[0]" id="expdate0" style="background-color:#ccc;" readonly="">
                                        </td>
                                        <td>
                                            <input type="text" name="docstok_awal[0]" id="docstok_awal0" style="background-color:#ccc;" readonly="" >
                                        </td>
                                        
                                        <td>
                                            <input type="text" name="qty[0]" id="qty0" >
                                        </td>
                                        <td>
                                            <select name="newbatchdetail[0]" id="newbatchdetail0" onkeyup="caribatch(0)" onchange="setnewBatch(0)" style="width: 200px">
                                            </select>
                                           <!--  <input type="text" name="newbatchdetail[0]" id="newbatchdetail0" onkeyup="caribatch(0)" onchange="setnewBatch(0)" style="width: 200px"> -->
                                            
                                        </td>
                                        <td>
                                            <input type="text" name="newbatch[0]" id="newbatch0" >
                                        </td>
                                        <td>
                                            <input type="text" name="expdate_akhir[0]" id="expdate_akhir0" value="{{tgl}}">
                                        </td>
                                        <td>
                                            <input type="text" name="docstok_akhir[0]" id="docstok_akhir0" style="background-color:#ccc;" readonly="">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>   
                            <input type="hidden" name="bucket" id="bucket" value="0">   
                        </div>
                    </div>                    
                    <div class="form-group" align="center">
                        <button type="button" id="btnSave" onclick="saveData()" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-danger">Cancel</button>
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
        </div>
        <!-- /.col-lg-12 -->   
    </div>
    <!-- /.row -->
</div>
<!-- /#page-wrapper -->
</form>

{% endblock %}

{% block js %}
<script type="text/javascript">
$(document).on('keydown', '.newRow', function(e) { 
  var keyCode = e.keyCode || e.which; 

  if (keyCode == 9 && e.shiftKey == false) { 
    addRow();
    // call custom function here
  } 
});

$(document).on('keydown', '.delRow', function(e) { 
  var keyCode = e.keyCode || e.which; 

  if (e.shiftKey && keyCode === 9) { 
    removeRow();
    // call custom function here
  } 
});

document.onkeydown=function(e){
        if (e.which == 112) {
            e.preventDefault();
            addRow();
            var b = document.getElementById('bucket').value;
            $('#produk'+b).focus();
        }
        if (e.which == 113) {
            e.preventDefault();
            saveData();
        }
        if(e.which == 115) {
            e.preventDefault();
            var b = document.getElementById('bucket').value;
            if (b > 0) {
                removeRow();
            }
        }
    }

var produkSource = [];
var newbatchSource = [];
$(document).ready(function() {      
    // START AUTOCOMPLETE PRODUK
        $.ajax({
            url : "{{ base_url }}produkInStok",
            type: "GET",
            dataType: "JSON",
            success: function(data)
            {
                // if(data.substr(0,2) != "[{"){
                //     var data = data.substr(1);
                //     var data = JSON.parse(data); 
                // }else{
                //     var data = JSON.parse(data);
                // }
                for (var i in data) {
                    produkSource[i] = data[i].Kode_Produk + "~" + data[i].Produk;
                }

            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                notif('warning', 'PERHATIAN! Gagal tarik data produk');
            }
        });   

        $.ajax({
            url : "{{ base_url }}allbatchInStok",
            type: "GET",
            dataType: "JSON",
            success: function(data)
            {
                // if(data.substr(0,2) != "[{"){
                //     var data = data.substr(1);
                //     var data = JSON.parse(data); 
                // }else{
                //     var data = JSON.parse(data);
                // }
                for (var i in data) {
                    newbatchSource[i] = data[i].BatchNo + "~" + data[i].ExpDate + "~" + data[i].UnitStok +"~"+data[i].NoDokumen;
                }

            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                notif('warning', 'PERHATIAN! Gagal tarik data batch');
            }
        });   
    // FINISH AUTOCOMPLETE PRODUK
});


    function cariKode(e){    
        $('#produk'+e).typeahead({
                source: produkSource
            });
    }

    function caribatch(e){    
        $('#newbatchdetail'+e).typeahead({
                source: newbatchSource
            });
    }

    function getProduk(e){
        var bucket =document.getElementById('bucket').value; 
        var Value = document.getElementById('produk'+e).value;
        var split = Value.split("~");
        var Kode = split[0];
        getBatch(e);
        // getnewBatch(e)
        $.ajax({
            url : "{{ base_url }}getHargaProduk/" + Kode,
            type: "GET",
            // dataType: "JSON",
            success: function(data)
            {   
                if (data) {      
                    $('#value'+e).val(data.HNA);
                }
                else{                           
                    $('#value'+e).val(""); 
                }
            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                
            }
        });
    }

     function getBatch(e) {
        $("#batch"+e).val('');
        $("#expdate"+e).val('');
        $("#stok"+e).val('');
        $("#docstok_awal"+e).val('');
        $('#newbatchdetail'+e).empty();
        var val = document.getElementById('produk'+e).value;
        var gudang = document.getElementById('gudang').value;
        var split = val.split("~");
        var Kode = split[0];
        $.ajax({
            url : "{{ base_url }}batchInKoreksi/" + Kode +'~'+ gudang,
            type: "GET",
            // dataType: "JSON",
            success: function(data)
            {  
                if(data.substr(0,2) != "[{"){
                    var data = data.substr(1);
                    var data = JSON.parse(data); 
                }else{
                    var data = JSON.parse(data);
                } 
                $("#batchdetail"+e).empty();
                $("#batchdetail"+e).append('<option value="">Pilih</option>');
                $("#newbatchdetail"+e).empty();
                $("#newbatchdetail"+e).append('<option value="">Pilih</option>');
                for (var i in data) {
                    $("#batchdetail"+e).append('<option value="'+data[i].BatchNo+' - '+data[i].ExpDate+' - '+data[i].UnitStok+' - '+data[i].NoDokumen+'">'+data[i].BatchNo+' - '+data[i].ExpDate+' - '+data[i].UnitStok+' - '+data[i].NoDokumen+'</option>');
                    $("#newbatchdetail"+e).append('<option value="'+data[i].BatchNo+' - '+data[i].ExpDate+' - '+data[i].UnitStok+' - '+data[i].NoDokumen+'">'+data[i].BatchNo+' - '+data[i].ExpDate+' - '+data[i].UnitStok+' - '+data[i].NoDokumen+'</option>');
                }
            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                notif('warning', 'PERHATIAN! Gagal tarik data batch');
            }
        });
    }

    function getnewBatch(e) {
        $("#newbatch"+e).val('');
        $("#expdate_akhir"+e).val('');
        $("#docstok_akhir"+e).val('');
        $('#batchdetail'+e).empty();
        $('#newbatchdetail'+e).empty();
        // var val = document.getElementById('produk'+e).value;
        // var split = val.split("~");
        // var Kode = split[0];
        $.ajax({
            url : "{{ base_url }}allbatchInStok/",
            type: "GET",
            // dataType: "JSON",
            success: function(data)
            {  
                if(data.substr(0,2) != "[{"){
                    var data = data.substr(1);
                    var data = JSON.parse(data); 
                }else{
                    var data = JSON.parse(data);
                } 
                $("#newbatchdetail"+e).empty();
                $("#newbatchdetail"+e).append('<option value="">Pilih</option>');
                for (var i in data) {
                    $("#newbatchdetail"+e).append('<option value="'+data[i].BatchNo+' - '+data[i].ExpDate+' - '+data[i].UnitStok+' - '+data[i].NoDokumen+'">'+data[i].BatchNo+' - '+data[i].ExpDate+' - '+data[i].UnitStok+' - '+data[i].NoDokumen+'</option>');
                }
            },
            error: function (jqXHR, textStatus, errorThrown)
            {
                notif('warning', 'PERHATIAN! Gagal tarik data batch');
            }
        });
    }

    function setBatch(e) {        
        var detail =document.getElementById('batchdetail'+e).value;         
        var split = detail.split(" - ");
        $("#batch"+e).val('');
        $("#expdate"+e).val('');
        $("#stok"+e).val('');
        $("#docstok_awal"+e).val('');
        $("#batch"+e).val(split[0]);
        $("#expdate"+e).val(split[1]);
        $("#stok"+e).val(split[2]);
        $("#docstok_awal"+e).val(split[3]);
    }

    function setnewBatch(e) {        
        var detail =document.getElementById('newbatchdetail'+e).value;         
        var split = detail.split(" - ");
        $("#newbatch"+e).val('');
        $("#expdate_akhir"+e).val('');
        $("#docstok_akhir"+e).val('');

        $("#newbatch"+e).val(split[0]);
        $("#expdate_akhir"+e).val(split[1]);
        $("#docstok_akhir"+e).val(split[3]);
        // $("#stok"+e).val(split[2]);
    }

    var rowNum = 0;
    function addRow(frm)
    {
        var b = document.getElementById('bucket').value;
        $('#removeRow').show();
        rowNum ++;
        var x = rowNum + 1;
        $('#table-produk').append('<tr id="itemRow'+rowNum+'"><td>1</td><td><input type="text" name="produk['+rowNum+']" id="produk'+rowNum+'" class="delRow"  onkeyup="cariKode('+rowNum+')" onchange="getProduk('+rowNum+')" autocomplete="off"></td><td><select name="batchdetail['+rowNum+']" id="batchdetail'+rowNum+'" onchange="setBatch('+rowNum+')" style="width: 200px"></select></td><td><input type="text" name="batch['+rowNum+']" id="batch'+rowNum+'" style="background-color:#ccc;" readonly=""></td><td><input type="text" name="stok['+rowNum+']" id="stok'+rowNum+'" style="background-color:#ccc;" readonly=""></td><td><input type="text" name="expdate['+rowNum+']" id="expdate'+rowNum+'" style="background-color:#ccc;" readonly=""></td><td><input type="text" name="docstok_awal['+rowNum+']" id="docstok_awal'+rowNum+'" style="background-color:#ccc;" readonly=""></td><td><input type="text" name="qty['+rowNum+']" id="qty'+rowNum+'" ></td><td><select name="newbatchdetail['+rowNum+']" id="newbatchdetail'+rowNum+'" onkeyup="caribatch('+rowNum+')" onchange="setnewBatch('+rowNum+')" style="width: 200px"></select></td><td><input type="text" name="newbatch['+rowNum+']" id="newbatch'+rowNum+'" ></td><td><input type="text" name="expdate_akhir['+rowNum+']" id="expdate_akhir'+rowNum+'" value="{{tgl}}"></td><td><input type="text" name="docstok_akhir['+rowNum+']" id="docstok_akhir'+rowNum+'" style="background-color:#ccc;" readonly=""></td></tr>');

        $('#bucket').val(rowNum);
    }

    function removeRow() 
    {        
        if (rowNum>0) {
            jQuery('#itemRow'+rowNum).remove();
            rowNum--;
        }
        else{

            notif('warning', 'PERHATIAN! Baris pertama tidak bisa dihapus');
        }
        $('#bucket').val(rowNum);
    }

    function saveData(e)
    {
        var bucket = document.getElementById('bucket').value;
        var status = false;

        for (var e = 0; e <= bucket; e++) {
            var batch = document.getElementById('batch'+e).value;
            var newbatch = document.getElementById('newbatch'+e).value;
            var docbatch = document.getElementById('docstok_awal'+e).value;
            var docnewbatch = document.getElementById('docstok_akhir'+e).value;
            var stok = parseInt(document.getElementById('stok'+e).value);
            var qty = parseInt(document.getElementById('qty'+e).value);
            if(batch == "" || newbatch == ""){
                notif("warning","Informasi Batch tidak Boleh Kosong");
                return;
            }
            if(batch == newbatch){
                notif("warning","Informasi Batch tidak Boleh Sama");
                return;
            }
            if(docbatch == docnewbatch){
                notif("warning","Infomasi Dokumen Batch tidak Boleh sama");
                document.getElementById('batch'+e).value ="";
                return;
            }
            if(qty == 0 || qty == ""){
                 notif("warning","Jumlah Tidak Boleh Kosong");
                return;
            }
            if(stok < qty){
                notif("warning","Jumlah Mutasi Tidak Boleh Melebihi Jumlah Stock");
                return;
            }
        }
        $("#notif").empty();
        $('#progressGIF').show();
        $.ajax({
            url : "{{ base_url }}saveMutasiBatch/",
            type: "POST",
            data: $('#myForm').serialize(),
            dataType: "JSON",
            success: function(data)
            {                
                if (data.status == false) {
                    notif('warning', 'PERHATIAN! Tidak dapat terhubung dengan server pusat');
                }
                else{
                    notif('success', 'SUKSES! Data berhasil disimpan'); 
                }
                $('#progressGIF').hide();
                location.reload();
            },
            error: function (jqXHR, textStatus, errorThrown)
            {
               notif('warning', 'PERHATIAN! Tidak dapat terhubung dengan server pusat. Data hanya tersimpan di server cabang.');
               $('#progressGIF').hide();
               location.reload();
            }
        });      
    }
</script>

{% endblock %}