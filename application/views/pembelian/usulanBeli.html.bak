{% extends "layout.html" %} {% block content %} {% include "navigation.html" %}
<style type="text/css">
    textarea {
        resize: none;
    }
    .dropdown-menu{
        font-size: 12px !important;
    }
    th{
        text-align: center !important;
    }
    .hide{
        display: none;
    }
    input, select{
        font-family: inherit;
        font-size: 11px;
        line-height: normal;
    }
</style>

<div id="progressGIF" style="position: fixed; top:0px; left:0px; bottom:0px; right:0px; background-color: rgba(0, 0, 0, 0.10); z-index: 1000; display: none">
    <center>
    <img src="{{base_url}}assets/img/progress.gif" width="150px" style="padding-top: 15%; position: relative;">
    <p style="position: relative; font-size: 18px;">DATA SEDANG DI PROSES</p>
    </center>
</div>

<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">

            <!-- <h1 class="page-header">Buat Usulan Beli</h1> -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                 <table>
                    <tr>
                        <td width="200">
                            <strong> Form Buat Usulan Beli </strong>   
                        </td>
                        <td>
                            <input type="hidden" name="counter" value="{{counter}}">
                                {% for cabang in cabang %}
                                    {% if cabang.Cabang == logs.cabang %} 
                                        <input class="form-control" type="text" name="Cabang" id="Cabang" readonly="" value="{{ cabang.Cabang }}-{{ cabang.Kode }}">
                                    {% endif %}
                                {% endfor %}
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </td>
                        <td>
                            <input class="form-control" type="text" name="Tanggal" id="Tanggal" value="{{tgl}}" readonly="">
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </td>
                        <td width="200">
                            <input type="hidden" class="form-control" name="NoUsulan" id="NoUsulan" readonly="">
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </td>
                        <td><label class="control-label">Sisa Limit</label></td>
                        <td>
                            <input class="form-control" name="SisaLimit" id="SisaLimit" readonly="">
                            <input class="form-control" type="hidden" name="limit" id="limit">
                            <input class="form-control" type="hidden" name="po" id="po">
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </td>
                        <td><label class="control-label">Total Value</label></td>
                        <td>
                            <input class="form-control" name="TotalValueMask" id="TotalValueMask" readonly="">
                            <input class="form-control" type="hidden" name="TotalValue" id="TotalValue">
                            <!-- <p class="help-block">notifikasi disini...</p> -->
                        </td>
                    </tr>
                </table>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <form role="form" method="post" id="myForm" enctype="multipart/form-data">
                                <div class="form-group">
                                    <div class="table-responsive">
                                        <table class="table" id="table-barang">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Prinsipal</th>
                                                    <th>Supplier</th>
                                                    <th>Produk</th>
                                                    <th>Qty</th>
                                                    <th>Disc</th>
                                                    <th>Bonus</th>
                                                    <th>Harga Deal</th>
                                                    <th>HPC</th>
                                                    <th>Disc Cab</th>
                                                    <th>Value</th>
                                                    <th>Keterangan</th>
                                                    <th>Ket.Internal</th>
                                                    <th>Qty REC</th>
                                                    <th>Satuan</th>
                                                    <th>Kategori</th>
                                                    <th>Stok</th>
                                                    <th>GIT</th>
                                                    <th>Avg</th>
                                                    <th>indeks</th>
                                                    <th>HPP</th>
                                                    <th>Disc Pst</th>
                                                    <th>Value PO</th>
                                                    <th>No</th>
                                                    <th>View GIT</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr id="itemRow0">
                                                    <td></td>
                                                    <td>
                                                        <!-- <select id="Prinsipal0" name="Prinsipal[0]" onfocus="getPrinsipal(0)" onchange="prinsipal(0)">
                                                            <option value="">--- Silahkan Pilih Prinsipal ---</option>
                                                            {% for prinsipal in prinsipal %}
                                                                <option value="{{ prinsipal.Prinsipal }}~{{prinsipal.Supplier}}">{{ prinsipal.Prinsipal }}</option>
                                                            {% endfor %}
                                                        </select> -->
                                                        <input type="text" name="Prinsipal[0]" id="Prinsipal0" onfocus="getPrinsipal(0)" onchange="prinsipal(0)">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Supplier[0]" id="Supplier0" readonly="">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Produk[0]" id="Produk0" style="
                                                        width:150px" onkeyup="cariKode(0)" onchange="getProduk(0)">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Qty[0]" id="Qty0" style="width: 50px" onkeyup="hitung()" onchange="hitung()">
                                                    </td>
                                                    <td>
                                                        <input type="number" step="0.01" min="0" name="Diskon[0]" id="Diskon0" style="width: 50px;" onkeyup="hitung()" onchange="hitung()">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Bonus[0]" id="Bonus0" style="width: 50px" onkeyup="hitung()" onchange="hitung()">
                                                    </td>
                                                    <td>    
                                                        <input type="text" name="HargaDeal[0]" id="HargaDeal0" style="width: 75px" onkeyup="hitung()" onchange="hitung()">
                                                        </td>
                                                    <td>
                                                        <input type="text" name="HPC[0]" id="HPC0" readonly="" style="background-color: #eee; width: 75px">
                                                        <input type="hidden" name="HBC[0]" id="HBC0">
                                                    </td>
                                                    <td>
                                                        <input type="number" step="0.01" min="0" name="DiscCab[0]" id="DiscCab0" readonly="" style="background-color: #eee; width: 50px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Value[0]" id="Value0" readonly="" style="background-color: #eee; width: 75px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Keterangan[0]" id="Keterangan0" style="
                                                        width:150px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="KetInternal[0]" id="KetInternal0" style="width: 300px;">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="QtyRec[0]" id="QtyRec0" readonly="" style="background-color: #eee; width: 50px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Satuan[0]" id="Satuan0" readonly="" style="background-color: #eee; width: 100px">
                                                    </td>
                                                    <td>
                                                    <input type="text" name="Kategori[0]" id="Kategori0" readonly="" style="background-color: #eee; width: 100px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Stok[0]" id="Stok0"  readonly="" style="background-color: #eee; width: 50px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="GIT[0]" id="GIT0" readonly="" style="background-color: #eee; width: 50px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Avg[0]" id="Avg0" readonly="" style="background-color: #eee; width: 50px">
                                                    </td>
                                                    <td>
                                                    {% for cabang in cabang %}
                                                        {% if cabang.Cabang == logs.cabang %} 
                                                        <input type="number" step="0.01" name="Indeks[0]" id="Indeks0" readonly="" style="background-color: #eee; width: 50px" value="{{cabang.Indeks_Pesan}}" >
                                                        {% endif %}
                                                    {% endfor %}
                                                    </td>
                                                    <td>
                                                        <input type="text" name="HPP[0]" id="HPP0" readonly="" style="background-color: #eee; width: 50px">
                                                        <input type="hidden" name="HBP[0]" id="HBP0">
                                                    </td>
                                                    <td>
                                                        <input type="number" step="0.01" min="0" name="DscPst[0]" id="DscPSt0"  readonly="" style="background-color: #eee; width: 50px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="ValuePO[0]" id="ValuePO0" readonly="" style="background-color: #eee; width: 50px">
                                                    </td>
                                                    <td>
                                                        <input type="text" name="No[0]" id="No0" readonly="" style="background-color: #eee; width: 50px">
                                                        <input type="hidden" name="PotonganCab[0]" id="PotonganCab0">
                                                    </td>
                                                    <td>
                                                        <button tipe="button" style="width: 100px; height: 26px">View GIT</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- /.table-responsive -->
                                    <div align="center">
                                        <input type="hidden" name="bucket" id="bucket" value="0">
                                        <a href="javascript:void(0)" type="submit" class="btn btn-success" onclick="addRow(this.form);">Tambah Barang</a>                                        
                                        <button type="reset" class="btn btn-default">Reset Form</button>
                                        <a href="javascript:void(0)" type="submit" class="btn btn-danger" id="removeRow" onclick="removeRow();">Hapus Baris</a>
                                    </div>
                                </div>                                
                                <div class="form-group" id="frmKeperluan" style="display: none;">
                                    <label class="control-label">Keperluan</label>
                                    <input class="form-control" type="text" name="Keperluan" id="Keperluan">
                                    <!-- <p class="help-block">notifikasi disini...</p> -->
                                </div>
                                <div class="form-group" id="frmNamaKep" style="display: none;">
                                    <label class="control-label">Nama Keperluan</label>
                                    <input class="form-control" type="text" name="NamaKep" id="NamaKep">
                                    <!-- <p class="help-block">notifikasi disini...</p> -->
                                </div>
                                <div class="form-group" id="frmAlamatKep" style="display: none;">
                                    <label class="control-label">Alamat Keperluan</label>
                                    <input class="form-control" type="text" name="AlamatKep" id="AlamatKep">
                                    <!-- <p class="help-block">notifikasi disini...</p> -->
                                </div>
                                <div class="form-group">
                                <table>
                                    <tr>
                                        <td valign="top">
                                            <input type="hidden" name="counter" value="{{counter}}">
                                            <label class="control-label">Dokumen</label>
                                            <input type="file" class="form-control" name="Dokumen" id="Dokumen">
                                            <!-- <p class="help-block">notifikasi disini...</p> -->
                                        </td>
                                        <td valign="top">
                                            <label class="control-label">Dokumen 2</label>
                                            <input type="file" class="form-control" name="Dokumen2" id="Dokumen2">
                                            <!-- <p class="help-block">notifikasi disini...</p> -->
                                        </td>
                                    </tr>
                                </table>
                                </div>
                                </div>
                                <hr>
                                <button type="button" id="btnSave" onclick="saveData()" class="btn btn-primary">Save</button>
                                <button type="button" class="btn btn-danger">Cancel</button>
                            </form>
                        </div>
                    </div>
                    <!-- /.row (nested) -->
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
</div>
<!-- /#page-wrapper -->

{% endblock %}


{% block js %}
<script type="text/javascript">
document.onkeyup=function(e){
    var e = e || window.event; // for IE to cover IEs window object
    // tambah row
    if(e.altKey == true && e.which == 78) {
         addRow();
         return false;
    }
}
$(document).ready(function() {        
        $('#removeRow').hide();
        $('#myForm')[0].reset(); // reset form on modals
        $('.selectpicker').selectpicker('val', '');
        $('#Prinsipal0').focus();
});

    // START TAMBAH & HAPUS ROW BARANG
    var rowNum = 0;
    function addRow(frm)
    {
        var b = document.getElementById('bucket').value;
        var s = document.getElementById('Satuan'+b).value;
        if (s) {
            $('#removeRow').show();
            rowNum ++;

            $('#table-barang').append($('<tr id="itemRow'+rowNum+'"><td></td><td><input type="text" name="Prinsipal['+rowNum+']" id="Prinsipal'+rowNum+'" onfocus="getPrinsipal('+rowNum+')" onchange="prinsipal('+rowNum+')"></td><td><input type="text" name="Supplier['+rowNum+']" id="Supplier'+rowNum+'" readonly="" onchange="loadProduk('+rowNum+')"></td><td><input type="text" name="Produk['+rowNum+']" id="Produk'+rowNum+'" style="width:150px" onkeyup="cariKode('+rowNum+')" onchange="getProduk('+rowNum+')"></td><td><input type="text" name="Qty['+rowNum+']" id="Qty'+rowNum+'" style="width: 50px" onkeyup="hitung()" onchange="hitung()"></td><td><input type="number" step="0.01" min="0" name="Diskon['+rowNum+']" id="Diskon'+rowNum+'" style="width: 50px;" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="Bonus['+rowNum+']" id="Bonus'+rowNum+'" style="width: 50px" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="HargaDeal['+rowNum+']" id="HargaDeal'+rowNum+'" style="width: 75px" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="HPC['+rowNum+']" id="HPC'+rowNum+'" readonly="" style="background-color: #eee; width: 75px"><input type="hidden" name="HBC['+rowNum+']" id="HBC'+rowNum+'"></td><td><input type="number" step="0.01" min="0" name="DiscCab['+rowNum+']" id="DiscCab'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="Value['+rowNum+']" id="Value'+rowNum+'" readonly="" style="background-color: #eee; width: 75px"></td><td><input type="text" name="Keterangan['+rowNum+']" id="Keterangan'+rowNum+'" style="width:150px"></td><td><input type="text" name="KetInternal['+rowNum+']" id="KetInternal'+rowNum+'" style="width: 300px;"></td><td><input type="text" name="QtyRec['+rowNum+']" id="QtyRec'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="Satuan['+rowNum+']" id="Satuan'+rowNum+'" readonly="" style="background-color: #eee; width: 100px"></td><td><input type="text" name="Kategori['+rowNum+']" id="Kategori'+rowNum+'" readonly="" style="background-color: #eee; width: 100px"></td><td><input type="text" name="Stok['+rowNum+']" id="Stok'+rowNum+'"  readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="GIT['+rowNum+']" id="GIT'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="Avg['+rowNum+']" id="Avg'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td>{% for cabang in cabang %}{% if cabang.Cabang == logs.cabang %} <input type="text" name="Indeks['+rowNum+']" id="Indeks'+rowNum+'" readonly="" style="background-color: #eee; width: 50px" value={{cabang.Indeks_Pesan}}></td>{% endif %}{% endfor %}<td><input type="text" name="HPP['+rowNum+']" id="HPP'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"><input type="hidden" name="HBP['+rowNum+']" id="HBP'+rowNum+'"></td><td><input type="number" step="0.01" min="0" name="DscPst['+rowNum+']" id="DscPSt'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="ValuePO['+rowNum+']" id="ValuePO'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="No['+rowNum+']" id="No'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"><input type="hidden" name="PotonganCab['+rowNum+']" id="PotonganCab'+rowNum+'"></td><td><button style="width: 100px; height: 26px" name="viewGIT['+rowNum+']" id="viewGIT'+rowNum+'">View GIT</button></td></tr>'));

            // $('#table-barang').append($('<tr id="itemRow'+rowNum+'"><td></td><td><input type="text" name="Prinsipal['+rowNum+']" id="Prinsipal'+rowNum+'" onfocus="getPrinsipal('+rowNum+')" onchange="prinsipal('+rowNum+')"></td><td><input type="text" name="Supplier['+rowNum+']" id="Supplier'+rowNum+'" readonly="" onchange="loadProduk('+rowNum+')"></td><td><input type="text" name="Produk['+rowNum+']" id="Produk'+rowNum+'" style="width:150px" onkeyup="cariKode('+rowNum+')" onchange="getProduk('+rowNum+')"></td><td><input type="text" name="Satuan['+rowNum+']" id="Satuan'+rowNum+'" readonly="" style="background-color: #eee; width: 100px"></td><td><input type="text" name="Kategori['+rowNum+']" id="Kategori'+rowNum+'" readonly="" style="background-color: #eee; width: 100px"></td><td><input type="text" name="Stok['+rowNum+']" id="Stok'+rowNum+'"  readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="GIT['+rowNum+']" id="GIT'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="Qty['+rowNum+']" id="Qty'+rowNum+'" style="width: 50px" onkeyup="hitung()" onchange="hitung()"></td><td><input type="number" step="0.01" min="0" name="Diskon['+rowNum+']" id="Diskon'+rowNum+'" style="width: 50px;" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="Bonus['+rowNum+']" id="Bonus'+rowNum+'" style="width: 50px" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="HargaDeal['+rowNum+']" id="HargaDeal'+rowNum+'" style="width: 75px" onkeyup="hitung()" onchange="hitung()"></td><td><input type="text" name="HPC['+rowNum+']" id="HPC'+rowNum+'" readonly="" style="background-color: #eee; width: 75px"><input type="hidden" name="HBC['+rowNum+']" id="HBC'+rowNum+'"></td><td><input type="number" step="0.01" min="0" name="DiscCab['+rowNum+']" id="DiscCab'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="Value['+rowNum+']" id="Value'+rowNum+'" readonly="" style="background-color: #eee; width: 75px"></td><td><input type="text" name="Keterangan['+rowNum+']" id="Keterangan'+rowNum+'" style="width:150px"></td><td><input type="text" name="KetInternal['+rowNum+']" id="KetInternal'+rowNum+'" style="width: 300px;"></td><td><input type="text" name="QtyRec['+rowNum+']" id="QtyRec'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="Avg['+rowNum+']" id="Avg'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><input type="text" name="Indeks['+rowNum+']" id="Indeks'+rowNum+'" readonly="" style="background-color: #eee; width: 50px"></td><td><button style="width: 100px; height: 26px" name="viewGIT['+rowNum+']" id="viewGIT'+rowNum+'">View GIT</button></td><td><input type="text" name="HPP['+rowNum+']" id="HPP'+rowNum+'" style="width: 75px"><input type="hidden" name="HBP['+rowNum+']" id="HBP'+rowNum+'"></td><td><input type="number" step="0.01" min="0" name="DscPst['+rowNum+']" id="DscPSt'+rowNum+'" style="width: 50px"></td><td><input type="text" name="ValuePO['+rowNum+']" id="ValuePO'+rowNum+'" style="width: 75px"></td><td><input type="text" name="No['+rowNum+']" id="No'+rowNum+'" style="width: 100px"><input type="hidden" name="PotonganCab['+rowNum+']" id="PotonganCab'+rowNum+'"></td></tr>'));

            $('#bucket').val(rowNum);
        }
        else
        {
            $("#notif").empty();
            notif('warning', 'PERHATIAN! Isi form diatas terlebih dahulu');
        }
    }

    function removeRow() 
    {
        jQuery('#itemRow'+rowNum).remove();
        rowNum--;
        if (rowNum==0) {
            $('#removeRow').hide();
        }
        $('#bucket').val(rowNum);
    }

    function clearRow(e) 
    {
        if (e == 'all') {
            var bucket = document.getElementById('bucket').value;
            for (var e = bucket; e > 0; e--) {            
                jQuery('#itemRow'+e).remove();            
                rowNum--;
            }
        $('#removeRow').hide();
        $('#bucket').val(rowNum);
        $('#frmKeperluan').hide();
        $('#frmNamaKep').hide();
        $('#frmAlamatKep').hide();
        }
        $('#Produk'+e).val("");
        $('#Kategori'+e).val("");
        $('#Satuan'+e).val("");
        $('#HPC'+e).val("");
        $('#HPP'+e).val("");
        $('#HBC'+e).val("");
        $('#HBP'+e).val("");
        $('#Qty'+e).val("");
        $('#Bonus'+e).val("");
        $('#Diskon'+e).val("");
        $('#HargaDeal'+e).val("");
        $('#Value'+e).val("");
        $('#Keterangan'+e).val("");
        $('#KetInternal'+e).val("");
    }


    var prinsipalSource = [];
    function getPrinsipal(e) {
        var i = 0;
        {% for prinsipal in prinsipal %}
            prinsipalSource[i] = '{{prinsipal.Prinsipal}}~{{prinsipal.Supplier}}';
            i++;
        {% endfor %}
        $('#Prinsipal'+e).typeahead({
                    source: prinsipalSource
                });
    }

    var supplierSource = [];
    function prinsipal(e) {
        var data = document.getElementById('Prinsipal'+e).value;
        var split = data.split("~");
        var prinsipal = split[0];
        var supplier = split[1];
        if (supplier != '') 
        {            
            $('#Supplier'+e).val('');
            $('#Supplier'+e).attr("readonly","readonly");
            $('#Supplier'+e).val(supplier);
        }
        else
        {
            $('#Supplier'+e).val('');
            $('#Supplier'+e).removeAttr("readonly");
            var i = 0;
            {% for supplier in supplier %}
                supplierSource[i] = '{{supplier.Supplier}}';
                i++;
            {% endfor %}

            $('#Supplier'+e).typeahead({
                    source: supplierSource
                });
        }
        clearRow(e);
        setNo(e);
        loadProduk(e);        
    }

    function setNo(e) {
        var cabang = document.getElementById('Cabang').value;
        var prinsipal = document.getElementById('Prinsipal'+e).value;
        if (cabang == "" || prinsipal == "") {
            
        }
        else
        {
            var currentdate = new Date();
            var datetime = currentdate.getDate() + "-"
                    + (currentdate.getMonth()+1)  + "-" 
                    + currentdate.getFullYear() + "/"  
                    + currentdate.getHours() + ":"  
                    + currentdate.getMinutes() + ":" 
                    + currentdate.getSeconds();

            var split = cabang.split("-");
            var Kode = split[1];
            var split2 = prinsipal.split("~");
            var prinspl = split2[0];

            $('#NoUsulan').val(Kode+'/'+prinspl+'/'+datetime);
        }
    }

    function getLimit() {
        var cabang = document.getElementById('Cabang').value;
        var split = cabang.split("-");
        var cab = split[0];

        $.ajax({
                url : "{{ base_url }}getLimit/",
                type: "POST",
                data:{cab:cab},
                dataType: "JSON",
                success: function(data)
                {
                    $('#limit').val(data.limit);
                    $('#po').val(data.po);
                    setNo();
                    hitung();
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    $("#notif").empty();
                    notif('danger','Error get list Produk from ajax');
                }
            });
    }

    function loadProduk(e) {
    var produkSource = [];
        var Prinsipal = document.getElementById('Prinsipal'+e).value;
        var Supplier = document.getElementById('Supplier'+e).value;
        var split2 = Prinsipal.split("~");
            var prinspl = split2[0];
        if ((Prinsipal) && (Supplier)) {
            $.ajax({
                url : "{{ base_url }}listProdukUsulanBeli/",
                type: "POST",
                data:{prinsipal:prinspl, supplier:Supplier},
                dataType: "JSON",
                success: function(data)
                {
                    for (var i in data) {
                        produkSource[i] = data[i].Kode_Produk+"~"+data[i].Produk;
                    }

                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    $("#notif").empty();
                    notif('danger','Error get list Produk from ajax');
                }
            });
            $('#Produk'+e).typeahead({
                    source: produkSource
                });
        }
        else{
            produkSource.length = 0;
        }
    }


    function cariKode(e){    
        var data = document.getElementById('Supplier'+e).value;
        if (data == "") {
            $("#notif").empty();
            // notif('warning', 'PERHATIAN! Mohon Pilih Pelanggan Terlebih Dahulu.', 'cariKode');
            notif('warning', 'PERHATIAN! Mohon Pilih Prinsipal + Supplier Terlebih Dahulu');
        }
            
    }

    var diskon = [];
    function getProduk(e){
        var bucket =document.getElementById('bucket').value; 
        var Value = document.getElementById('Produk'+e).value;
        var split = Value.split("~");
        var Kode = split[0];
        var Status = true;
        if (bucket > 0) {
            for (var i = 0; i < bucket; i++) {
                if (e != i) {
                    var Value2 = document.getElementById('Produk'+i).value;
                    var split2 = Value2.split("~");
                    var Kode2 = split2[0];
                    if (Kode === Kode2) 
                    { 
                        Status = false;
                        break;
                    }
                }
            }
        }

        if (Status == true) {
            $.ajax({
                url : "{{ base_url }}getProdukUsulanBeli/" + Kode,
                type: "GET",
                dataType: "JSON",
                success: function(data)
                {   
                    if (data)
                    {
                        if (data.Data) {                            
                            diskon = data.Diskon;
                            $('#Kategori'+e).val(data.Data.Kategori);
                            $('#Satuan'+e).val(data.Data.Satuan);
                            $('#HPC'+e).val(data.HBC);
                            $('#HPP'+e).val(data.HBP);
                            $('#HBC'+e).val(data.HBC);
                            $('#HBP'+e).val(data.HBP);
                            $('#Bonus'+e).val("");
                            $('#Diskon'+e).val("");
                            $('#Gross'+e).val("");
                            $('#Potongan'+e).val("");
                            $('#Value'+e).val("");
                            $('#PPN'+e).val("");
                            $('#Total'+e).val("");
                            $('#DiscCab'+e).val(data.DBC);
                            $('#DscPSt'+e).val(data.DBP);
                            cekHarga(e);
                            // if (data.Data.Kategori == 'Precursor' || data.Data.Kategori == 'Psikotropika' || data.Data.Kategori == 'OOT') 
                            // {
                            //     $('#Keperluan').show();
                            //     $('#NamaKep').show();
                            //     $('#AlamatKep').show();
                            // }
                        }
                        else{                            
                            $('#Qty'+e).val("");
                            $('#Bonus'+e).val("");
                            $('#Diskon'+e).val("");
                            $('#maxDiskon'+e).val("");
                            $('#Satuan'+e).val("");
                            $('#Harga'+e).val("");
                            $('#Gross'+e).val("");
                            $('#Potongan'+e).val("");
                            $('#Value'+e).val("");
                            $('#PPN'+e).val("");
                            $('#Total'+e).val("");
                            $('#DiscCab'+e).val("");
                            $('#DscPSt'+e).val("");
                        }
                    }
                    else
                    {                        
                        $('#Satuan'+e).val("");
                    }
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    
                }
            });
        }
        else
        {
            $("#notif").empty();
            notif('warning','Duplikat Produk');
            $('#Produk'+e).val("");
        }
    }

    function cekHarga(e) {
        var Satuan = document.getElementById('Satuan'+e).value;
        var HBC = document.getElementById('HBC'+e).value;
        var HBP = document.getElementById('HBP'+e).value;
        var Kategori = document.getElementById('Kategori'+e).value;

        if (Satuan != "") {
            if (HBC == "" || HBP == "") {
                $("#notif").empty();
                notif('warning', 'PERHATIAN! Data Harga Beli Cabang & Harga Beli Pusat kosong.');
                $('#Produk'+e).val("");
                $('#Satuan'+e).val("");
                $('#Kategori'+e).val("");
                $('#HPC'+e).val("");
                $('#HPP'+e).val("");
                $('#HBC'+e).val("");
                $('#HBP'+e).val("");

            }
            else{
                if (Kategori == "Psikotropika" || Kategori == 'Precursor' || Kategori == 'OOT') 
                {
                    $('#frmKeperluan').show();
                    $('#frmNamaKep').show();
                    $('#frmAlamatKep').show();
                }
            }
        }
    }

    function saveData()
    {
        $("#notif").empty();
        var url = "{{ base_url }}saveDataUsulanBeli"; 

        var bucket = document.getElementById('bucket').value;
        var cabang = document.getElementById('Cabang').value;
        
        var Keperluan = document.getElementById('Keperluan').value;
        var NamaKep = document.getElementById('NamaKep').value;
        var AlamatKep = document.getElementById('AlamatKep').value;
        var status = true;

        if (cabang == "") {
            notif('warning', 'PERHATIAN! Data Cabang Belum Dipilih');
            // alert('PERHATIAN! Data Cabang Belum Dipilih');
            status=false;
        }
        
        for (var i = 0; i <= bucket; i++) {
            var Produk = document.getElementById('Produk'+i).value;
            var Satuan = document.getElementById('Satuan'+i).value;   
            var Kategori = document.getElementById('Kategori'+i).value;   

            if (Produk == "" || Satuan == "") 
            {
                // notif('warning', 'PERHATIAN! Data Barang Belum Lengkap. Hapus Baris Jika Tidak Diperlukan.', 'produk');
                notif('warning', 'PERHATIAN! Data Barang Belum Lengkap. Hapus Baris Jika Tidak Diperlukan');
                status=false;
            } 

            if (Kategori == 'Psikotropika' || Kategori == 'Precursor' || Kategori == 'OOT') 
            {
                if (Keperluan == '' || NamaKep == '' || AlamatKep == '') 
                {
                    notif('warning', 'PERHATIAN! Terdapat Produk dengan kategori "Psikotropika", "Precursor", "OOT". Keperluan, Nama Keperluan dan Alamat Keperluan WAJIB diisi.');
                    status=false;
                }
            }
        }
        // ajax adding data to database
        if (status==true) {
            $('#progressGIF').show();
            var formdata = new FormData();      
            // append tipe file
            var Dokumen = $('#Dokumen')[0].files[0];
            formdata.append('Dokumen', Dokumen);

            var Dokumen2 = $('#Dokumen2')[0].files[0];
            formdata.append('Dokumen2', Dokumen2);

            $.each($('#myForm').serializeArray(), function(a, b){
                formdata.append(b.name, b.value);
            });
         
            var formData = new FormData($('#myForm')[0]);

            $.ajax({
                url : url,
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                dataType: "JSON",
                success: function(data)
                {
                    if (data.status == false) {
                        // notif('danger', 'PERHATIAN! Data Pelanggan & Salesman Harus Sesuai Dengan List.', 'saveResult');
                        notif('warning', 'PERHATIAN! Tidak dapat terhubung dengan server pusat');
                    }
                    else{
                        notif('success', 'SUKSES! Data berhasil disimpan');                          
                        clearRow('all');
                        $('#myForm')[0].reset(); 
                    }
                    $('#progressGIF').hide();
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    // notif('danger', 'PERHATIAN! Save Data Order GAGAL.', 'gagal');
                    notif('danger', 'PERHATIAN! Save Data Usulan Beli GAGAL');
                    $('#progressGIF').hide();
                }
            });
        }
    }

    function hitung() {
        var bucket = ((document.getElementById('bucket').value) ? document.getElementById('bucket').value : 0);
        var limit = ((document.getElementById('limit').value) ? document.getElementById('limit').value : 0);
        var po = ((document.getElementById('limit').value) ? document.getElementById('po').value : 0);
        var summary = 0;
        for (var e = 0; e <= bucket; e++) {
            var Qty = ((document.getElementById('Qty'+e).value) ? document.getElementById('Qty'+e).value : 0);
            var Diskon = ((document.getElementById('Diskon'+e).value) ? document.getElementById('Diskon'+e).value : 0);
            var DiskonMC = ((document.getElementById('DiscCab'+e).value) ? document.getElementById('DiscCab'+e).value : 0);
            var DiskonMP = ((document.getElementById('DscPSt'+e).value) ? document.getElementById('DscPSt'+e).value : 0);
            var Bonus = ((document.getElementById('Bonus'+e).value) ? document.getElementById('Bonus'+e).value : 0);
            var HargaDeal = ((document.getElementById('HargaDeal'+e).value) ? document.getElementById('HargaDeal'+e).value : 0);

            var HBP = ((document.getElementById('HBP'+e).value) ? document.getElementById('HBP'+e).value : 0);
            var HBC = ((document.getElementById('HBC'+e).value) ? document.getElementById('HBC'+e).value : 0);

            var hpc = 0;
            var hpp = 0;
            var value = 0;
            var valueP = 0;

            if(Diskon != 0)
            {
                var diskon = Diskon/100;
            }else
            {
                var diskon = DiskonMC/100;
            }

            var diskonP = DiskonMP/100;

            // diskon HPC HPP
            hpp = HBP - (HBP*diskonP);
            hpc = HBC - (HBC*diskon);
            $('#HPC'+e).val(hpc.toFixed(2));
            $('#HPP'+e).val(hpp.toFixed(2));


            // Nilai VALUE Usulan
            if (HargaDeal == 0) {
                value = Qty * hpc;                               
                var disc = ( HBC * Qty ) * ( Diskon / 100 );
                var potongan = ( Bonus * HBC ) + disc;                 
                var ppn = value * ( 10 / 100 );
                //value = value+ppn;
            }
            else
            {
                value = Qty * (HargaDeal - (HargaDeal*diskon));  
                var disc = ( HargaDeal * Qty ) * ( Diskon / 100 );
                var potongan = ( Bonus * HargaDeal ) + disc;  
                var ppn = value * ( 10 / 100 );
                //value = value+ppn;
            }

            // nilai Value PO
            valueP = hpp * Qty;
            $('#ValuePO'+e).val(valueP.toFixed(2));

            $('#Value'+e).val(value.toFixed(2));
            $('#PotonganCab'+e).val(potongan.toFixed(2));
            summary = summary + value;
        }
            $('#TotalValueMask').val(summary.toFixed(2));
            var sisa = parseInt(limit) - parseInt(po) - parseInt(summary);
            $('#SisaLimit').val(sisa.toFixed(2));
    }
    
</script>
{% endblock %}